<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - NF M√≥veis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/css/style.css">
</head>
<body class="bg-gray-50 font-['Inter']">
    <header class="bg-gradient-to-r from-musgo to-petroleo text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-xl shadow-inner">üîß</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">NF M√≥veis Planejados</h1>
                    <p class="text-xs text-white/80">Painel Administrativo</p>
                </div>
            </div>
            <div id="loginInfo" class="hidden flex items-center gap-4">
                <span class="text-sm font-medium" id="adminNome"></span>
                <button onclick="logout()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm transition-all border border-white/20">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
            <div id="loginButton">
                <button onclick="showLoginModal()" class="bg-white text-musgo px-6 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition-all shadow-md">
                    <i class="fas fa-lock mr-2"></i>Login Admin
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md p-4 mb-8 sticky top-4 z-10 border border-gray-100">
            <div class="flex gap-2 overflow-x-auto pb-2 sm:pb-0">
                <button onclick="showTab('pendentes')" class="tab-btn active px-6 py-3 rounded-lg font-semibold text-sm bg-musgo text-white whitespace-nowrap" id="tab-pendentes">
                    <i class="fas fa-clock mr-2"></i>Pendentes
                </button>
                <button onclick="showTab('aprovados')" class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 whitespace-nowrap" id="tab-aprovados">
                    <i class="fas fa-check-circle mr-2"></i>Aprovados
                </button>
                <button onclick="showTab('rejeitados')" class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 whitespace-nowrap" id="tab-rejeitados">
                    <i class="fas fa-times-circle mr-2"></i>Rejeitados
                </button>
                <button onclick="showTab('ordens')" class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 whitespace-nowrap" id="tab-ordens">
                    <i class="fas fa-clipboard-list mr-2"></i>Ordens de Servi√ßo
                </button>
                <button onclick="showTab('nova-os')" class="tab-btn px-6 py-3 rounded-lg font-semibold text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 whitespace-nowrap" id="tab-nova-os">
                    <i class="fas fa-plus-circle mr-2"></i>Nova OS
                </button>
            </div>
        </div>

        <div id="pendentes-content" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-petroleo mb-6 flex items-center gap-2">
                    <i class="fas fa-user-clock text-amber-500"></i> Montadores Aguardando Aprova√ß√£o
                </h2>
                <div id="pendentes-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8 italic">Carregando...</div>
                </div>
            </div>
        </div>

        <div id="aprovados-content" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-petroleo mb-6 flex items-center gap-2">
                    <i class="fas fa-user-check text-green-500"></i> Montadores Ativos
                </h2>
                <div id="aprovados-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8 italic">Carregando...</div>
                </div>
            </div>
        </div>

        <div id="rejeitados-content" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-petroleo mb-6 flex items-center gap-2">
                    <i class="fas fa-user-times text-red-500"></i> Montadores Rejeitados
                </h2>
                <div id="rejeitados-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8 italic">Carregando...</div>
                </div>
            </div>
        </div>

        <div id="ordens-content" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-petroleo mb-6 flex items-center gap-2">
                    <i class="fas fa-list-check text-musgo"></i> Hist√≥rico de Ordens
                </h2>
                <div id="ordens-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8 italic">Carregando...</div>
                </div>
            </div>
        </div>

        <div id="nova-os-content" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-petroleo mb-6 flex items-center gap-2">
                    <i class="fas fa-file-signature text-musgo"></i> Criar Nova Ordem de Servi√ßo
                </h2>
                
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-8">
                    <h3 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                        <i class="fas fa-robot"></i> Automa√ß√£o de Convites
                    </h3>
                    <p class="text-xs text-blue-700 leading-relaxed">
                        Preencha os dados do servi√ßo abaixo. O sistema geolocalizar√° automaticamente os 3 montadores mais pr√≥ximos da obra dentro do raio escolhido e gerar√° links de convite v√°lidos por 20 minutos.
                    </p>
                </div>

                <form id="formNovaOS" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Cidade da Instala√ß√£o</label>
                            <input type="text" id="osCidade" placeholder="Ex: Goi√¢nia" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all" required>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Estado (UF)</label>
                            <input type="text" id="osEstado" value="GO" maxlength="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all uppercase" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Tipo de Projeto</label>
                            <select id="osTipo" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all bg-white" required>
                                <option value="simples">Simples (Cozinha/Quarto)</option>
                                <option value="medio">M√©dio (Apartamento Completo)</option>
                                <option value="complexo">Complexo (Casa/Escrit√≥rio)</option>
                                <option value="luxo">Super Luxo / Alto Padr√£o</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Valor Pago ao Montador (R$)</label>
                            <input type="number" id="osValor" step="0.01" placeholder="0,00" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all font-mono" required>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">Endere√ßo Completo da Obra</label>
                        <input type="text" id="osEndereco" placeholder="Rua, N√∫mero, Bairro..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Data Agendada</label>
                            <input type="date" id="osData" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all" required>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Raio de Busca de Montadores (km)</label>
                            <input type="number" id="raioBusca" value="100" min="5" max="500" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">Observa√ß√µes Internas</label>
                        <textarea id="osObs" rows="3" placeholder="Informa√ß√µes adicionais para o montador..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-musgo outline-none transition-all resize-none"></textarea>
                    </div>

                    <button type="submit" id="btnSalvarOS" class="w-full bg-musgo hover:bg-petroleo text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center gap-3">
                        <i class="fas fa-paper-plane"></i> Criar OS e Gerar Convites
                    </button>
                </form>

                <div id="resultadoConvites" class="hidden mt-10 p-6 bg-green-50 border-2 border-green-200 rounded-2xl animate-fade-in">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center shadow-md">
                            <i class="fas fa-check"></i>
                        </div>
                        <h4 class="font-extrabold text-green-900 text-lg" id="resultadoMensagem">OS Criada com Sucesso!</h4>
                    </div>
                    
                    <p class="text-sm text-green-800 mb-6 font-medium">Clique nos bot√µes abaixo para enviar os convites diretamente para os montadores selecionados:</p>
                    
                    <div id="linksConvites" class="space-y-4">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-[100] p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-musgo/10 text-musgo rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-black text-petroleo">Acesso Restrito</h2>
                <p class="text-gray-500 text-sm">Entre com suas credenciais de administrador</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">E-mail</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-musgo outline-none bg-gray-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Senha</label>
                    <input type="password" id="loginSenha" class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-musgo outline-none bg-gray-50">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="doLogin()" class="flex-1 bg-musgo hover:bg-petroleo text-white py-4 rounded-xl font-bold transition-all shadow-lg">Entrar</button>
                    <button onclick="hideLoginModal()" class="flex-1 border-2 border-gray-200 text-gray-500 py-4 rounded-xl font-bold hover:bg-gray-50 transition-all">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // 1. Detec√ß√£o inteligente da URL do servidor
    const isLocal = ['localhost', '127.0.0.1', ''].includes(window.location.hostname);
    const API_URL = isLocal 
        ? 'http://localhost:3000' 
        : 'https://testenf-production.up.railway.app';
    
    let token = localStorage.getItem('adminToken');

    document.addEventListener('DOMContentLoaded', () => {
        updateUIForLoggedIn();
        if (token) {
            verificarToken().then(valido => {
                if (valido) loadData('pendentes');
                else logout();
            });
        }
    });

    async function verificarToken() {
        if (!token) return false;
        try {
            const res = await fetch(`${API_URL}/api/admin/montadores?status=pendente&limit=1`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            return res.ok;
        } catch (err) { return false; }
    }

    function showLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
    function hideLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }

    async function doLogin() {
        const email = document.getElementById('loginEmail').value;
        const senha = document.getElementById('loginSenha').value;
        const btnLogin = document.querySelector('#loginModal button[onclick="doLogin()"]');
        if (!email || !senha) return alert('Preencha e-mail e senha.');

        try {
            btnLogin.innerText = 'Autenticando...';
            btnLogin.disabled = true;
            const res = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, senha })
            });
            const data = await res.json();
            if (res.ok) {
                token = data.token;
                localStorage.setItem('adminToken', token);
                localStorage.setItem('adminNome', data.usuario.nome);
                hideLoginModal();
                updateUIForLoggedIn();
                showTab('pendentes');
            } else { alert('Erro: ' + data.erro); }
        } catch (err) { alert('Erro ao conectar ao servidor.'); }
        finally { btnLogin.innerText = 'Entrar'; btnLogin.disabled = false; }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    function updateUIForLoggedIn() {
        const loginInfo = document.getElementById('loginInfo');
        const loginButton = document.getElementById('loginButton');
        const adminNome = document.getElementById('adminNome');
        if (token && localStorage.getItem('adminNome')) {
            loginInfo.classList.remove('hidden');
            loginButton.classList.add('hidden');
            adminNome.textContent = localStorage.getItem('adminNome');
        } else {
            loginInfo.classList.add('hidden');
            loginButton.classList.remove('hidden');
        }
    }

    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tab + '-content').classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-musgo', 'text-white', 'shadow-md');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });
        const activeBtn = document.getElementById('tab-' + tab);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
            activeBtn.classList.add('bg-musgo', 'text-white', 'shadow-md');
        }
        if (token) loadData(tab);
    }

    async function loadData(tab) {
        if (!token) return;
        try {
            let endpoint = `${API_URL}/api/admin/ordens`;
            if (['pendentes', 'aprovados', 'rejeitados'].includes(tab)) {
                const status = tab === 'pendentes' ? 'pendente' : tab === 'aprovados' ? 'aprovado' : 'rejeitado';
                endpoint = `${API_URL}/api/admin/montadores?status=${status}`;
            }
            const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if (tab === 'ordens') renderOrdens(data);
            else renderMontadores(data, tab);
        } catch (err) { console.error('Erro ao carregar dados:', err); }
    }

    // NOVA FUN√á√ÉO RENDERIZAR COM DOCUMENTOS
function renderMontadores(montadores, status) {
    const container = document.getElementById(status + '-list');
    if (!montadores.length) {
        container.innerHTML = '<div class="text-center text-gray-400 py-12 italic border-2 border-dashed rounded-xl">Vazio</div>';
        return;
    }
    container.innerHTML = montadores.map(m => {
        // L√≥gica atualizada para verificar os 4 documentos
        const temDocs = m.foto_perfil || m.doc_frente || m.doc_verso || m.comprovante_residencia;
        
        return `
        <div class="bg-white border-2 border-gray-100 rounded-2xl p-5 hover:border-musgo/30 transition-all shadow-sm group">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-bold text-lg text-petroleo group-hover:text-musgo transition-colors">${m.nome}</h3>
                    <p class="text-sm text-gray-500">${m.email} ‚Ä¢ ${m.telefone}</p>
                </div>
                <span class="text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full ${status === 'pendentes' ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}">${status}</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div><p class="text-[10px] text-gray-400 font-bold uppercase">Cidade/UF</p><p class="text-sm font-semibold text-gray-700">${m.cidade} - ${m.estado}</p></div>

<div>
  <p class="text-[10px] text-gray-400 font-bold uppercase">Exp.</p>
  <p class="text-sm font-semibold text-gray-700">${m.anos_exp || 'Iniciante'}</p>
</div>
            </div>

            <div class="mb-4">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Anexos e Documentos</p>
                <div class="flex flex-wrap gap-2">
                    ${m.foto_perfil ? `
                        <button onclick="abrirArquivo('${m.foto_perfil}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 border border-blue-200 transition-colors">
                            <i class="fas fa-image"></i> Foto Perfil
                        </button>` : ''}
                    
                    ${m.doc_frente ? `
                        <button onclick="abrirArquivo('${m.doc_frente}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 border border-blue-200 transition-colors">
                            <i class="fas fa-id-card"></i> Doc. Frente
                        </button>` : ''}
                    
                    ${m.doc_verso ? `
                        <button onclick="abrirArquivo('${m.doc_verso}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 border border-blue-200 transition-colors">
                            <i class="fas fa-id-card"></i> Doc. Verso
                        </button>` : ''}

                    ${m.comprovante_residencia ? `
                        <button onclick="abrirArquivo('${m.comprovante_residencia}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 border border-blue-200 transition-colors">
                            <i class="fas fa-file-contract"></i> Comprovante
                        </button>` : ''}
                    
                    ${!temDocs ? '<p class="text-xs text-gray-400 italic">Nenhum arquivo enviado</p>' : ''}
                </div>
            </div>

            ${status === 'pendentes' ? `
                <div class="flex gap-2">
                    <button onclick="aprovarMontador('${m.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg text-sm font-bold shadow-sm transition-all">Aprovar Cadastro</button>
                    <button onclick="rejeitarMontador('${m.id}')" class="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-2 rounded-lg text-sm font-bold transition-all">Recusar</button>
                </div>` : ''}
        </div>`;
    }).join('');
}
    // Fun√ß√£o para abrir o arquivo em tela cheia (Suporta Base64 ou Link)
    function abrirArquivo(urlOuBase64) {
        if (!urlOuBase64) return alert('Arquivo n√£o dispon√≠vel');
        const novaAba = window.open();
        if (urlOuBase64.startsWith('data:image') || urlOuBase64.startsWith('http')) {
             novaAba.document.write(`<body style="margin:0; background:#111; display:flex; align-items:center; justify-content:center;"><img src="${urlOuBase64}" style="max-width:100%; max-height:100vh; shadow: 0 0 50px rgba(0,0,0,0.5)"></body>`);
        } else {
             // Caso seja apenas o caminho do arquivo no servidor
             novaAba.location.href = urlOuBase64;
        }
    }

function renderOrdens(ordens) {
    const container = document.getElementById('ordens-list');
    if (!ordens.length) { 
        container.innerHTML = '<div class="text-center text-gray-400 py-12 italic border-2 border-dashed rounded-xl">Nenhuma ordem encontrada</div>'; 
        return; 
    }

    container.innerHTML = ordens.map(o => {
        // Formata√ß√£o das datas
        const dataCriacao = new Date(o.criado_em).toLocaleDateString('pt-BR');
        const dataAgendada = o.data_agendamento ? new Date(o.data_agendamento).toLocaleDateString('pt-BR') : 'N√£o informada';
        
        // Cores de status
        let statusClass = 'bg-blue-100 text-blue-700'; 
        if (o.status === 'pendente') statusClass = 'bg-amber-100 text-amber-700';
        if (o.status === 'conclu√≠da') statusClass = 'bg-green-100 text-green-700';

        // Limpeza do telefone para o link do WhatsApp
        const zapLink = o.montador_telefone ? `https://wa.me/55${o.montador_telefone.replace(/\D/g, '')}` : '#';

        return `
        <div class="bg-white border-2 ${o.status === 'conclu√≠da' ? 'border-green-100 bg-green-50/10' : 'border-gray-100'} rounded-2xl p-6 mb-4 shadow-sm transition-all hover:shadow-md">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="font-black text-petroleo text-lg">OS #${o.numero_os || o.id.toString().slice(0,8)}</h3>
                    <p class="text-[10px] text-gray-400 uppercase font-bold mt-1">Registrada em: ${dataCriacao}</p>
                </div>
                <span class="px-3 py-1 ${statusClass} rounded-full text-[10px] font-black uppercase tracking-wider">
                    ${o.status}
                </span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="space-y-3 border-r border-gray-100 pr-4">
                    <p class="flex items-center gap-2 text-sm text-gray-600">
                        <i class="fas fa-hammer text-musgo w-5"></i>
                        <span><b>Projeto:</b> ${o.tipo_projeto.toUpperCase()}</span>
                    </p>
                    <p class="flex items-center gap-2 text-sm text-gray-600">
                        <i class="fas fa-calendar-check text-musgo w-5"></i>
                        <span><b>Data Agendada:</b> ${dataAgendada}</span>
                    </p>
                    <p class="flex items-center gap-2 text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt text-musgo w-5"></i>
                        <span><b>Local:</b> ${o.cidade} - ${o.endereco_instalacao}</span>
                    </p>
                </div>

                <div class="space-y-3">
                    <p class="flex items-center gap-2 text-sm text-gray-600">
                        <i class="fas fa-user-hard-hat text-musgo w-5"></i>
                        <span><b>Montador:</b> ${o.montador_nome || '<span class="text-amber-600 italic">Pendente</span>'}</span>
                    </p>
                    ${o.montador_telefone ? `
                        <p class="flex items-center gap-2 text-sm text-gray-600">
                            <i class="fab fa-whatsapp text-green-500 w-5 text-lg"></i>
                            <a href="${zapLink}" target="_blank" class="text-blue-600 font-bold hover:underline">
                                ${o.montador_telefone}
                            </a>
                        </p>
                    ` : ''}
                    <div class="pt-2">
                         <span class="text-[10px] text-gray-400 font-bold uppercase block">Valor do Pagamento</span>
                         <span class="text-xl font-black text-musgo">R$ ${parseFloat(o.valor).toFixed(2)}</span>
                    </div>
                </div>
            </div>

            ${o.status !== 'conclu√≠da' ? `
                <button onclick="marcarComoConcluido('${o.id}')" class="w-full bg-musgo hover:bg-petroleo text-white py-4 rounded-xl font-bold text-sm transition-all shadow-md flex items-center justify-center gap-2">
                    <i class="fas fa-check-double"></i> FINALIZAR E ARQUIVAR TRABALHO
                </button>
            ` : `
                <div class="w-full bg-gray-50 text-gray-400 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 border border-dashed border-gray-200">
                    <i class="fas fa-archive"></i> SERVI√áO CONCLU√çDO E ARQUIVADO NO HIST√ìRICO
                </div>
            `}
        </div>`;
    }).join('');
}
    document.getElementById('formNovaOS').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSalvarOS');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';
        
        const osData = {
            tipo_projeto: document.getElementById('osTipo').value,
            valor: parseFloat(document.getElementById('osValor').value),
            endereco_instalacao: document.getElementById('osEndereco').value,
            cidade: document.getElementById('osCidade').value,
            estado: document.getElementById('osEstado').value,
            data_agendamento: document.getElementById('osData').value,
            observacoes: document.getElementById('osObs').value,
            raio_busca: parseInt(document.getElementById('raioBusca').value) || 100
        };

        try {
            const res = await fetch(`${API_URL}/api/admin/criar-os`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(osData)
            });
            const data = await res.json();
            if (res.ok) {
                e.target.reset();
                document.getElementById('resultadoConvites').classList.remove('hidden');
                document.getElementById('resultadoMensagem').innerHTML = `OS #${data.os.numero_os} Criada!`;
                document.getElementById('linksConvites').innerHTML = data.convites.map(c => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-xl border border-green-100 shadow-sm">
                        <span class="font-bold text-gray-800">${c.montador.nome}</span>
                        <a href="${c.whatsapp_link}" target="_blank" class="bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-black"><i class="fab fa-whatsapp"></i> ENVIAR ZAP</a>
                    </div>`).join('');
                document.getElementById('resultadoConvites').scrollIntoView({ behavior: 'smooth' });
            } else { alert(data.erro); }
        } catch (err) { alert('Erro ao criar OS'); }
        finally { btn.disabled = false; btn.innerHTML = 'Criar OS e Gerar Convites'; }
    });

    async function aprovarMontador(id) {
        if (!confirm('Aprovar este profissional?')) return;
        const res = await fetch(`${API_URL}/api/admin/aprovar-montador`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ montador_id: id })
        });
        if (res.ok) loadData('pendentes');
    }

    async function rejeitarMontador(id) {
        const motivo = prompt('Motivo da rejei√ß√£o:');
        if (motivo === null) return;
        const res = await fetch(`${API_URL}/api/admin/rejeitar-montador`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ montador_id: id, motivo })
        });
        if (res.ok) loadData('pendentes');
    }
async function marcarComoConcluido(id) {
    if (!confirm("Confirmar a conclus√£o deste servi√ßo?")) return;

    try {
        const res = await fetch(`${API_URL}/api/admin/concluir-os`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ os_id: id }) // O nome da chave deve ser os_id
        });

        const data = await res.json();

        if (res.ok) {
            alert('‚úÖ Servi√ßo conclu√≠do com sucesso!');
            loadData('ordens'); // Atualiza a tela
        } else {
            alert('Erro: ' + data.erro);
        }
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro de conex√£o com o servidor.');
    }
}
</script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        .tab-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 4px rgba(114, 133, 102, 0.1);
        }
    </style>
</body>
</html>
